---
title: "Reidentification Risk Analysis"
author: "xsong"
date: "10/10/2018"
output: html_document
---

### Reidentifiaction Risk Analysis ###

This document reports disclosure risks for 4 EHR data sets of Acute Kidney Injury (AKI) patients over 10 years at KU medical center with different observation points, which will be made open to public. 

***

#### Determining Key Variables ####
"Key variables", also called "implicit identifier" or "quasi-identifier", are defined as a set of variables that, when considered together, can be used to identify individual patients. Also "key variables" are, to some extent, more accessible to the public or to potential intruders. However, treating all 1,287 variables as key variables would result in higher risk of containing too many "unique" patterns. So, we attempted to just release a maximal set of variables which: a) still covers all distinct data types; and b) "Global risk", or population uniqueness, is below 0.03%. 

Note that in [sdcMicro Appendix A], only basic demographics are used as "key variables". We have tested the scenario of (age is discretized into 6 groups) only including age, gender, race as keys, and got all the re-identification risk measures below 0.03%.

[sdcMicro Appendix A]: https://cran.r-project.org/web/packages/sdcMicro/vignettes/sdc_guidelines.pdf


#### Measuring the Re-identification/Disclosure Risk ####
Table1 demonstrates results of 5 disclusure risk measures for all the 4 EHR data sets in request. 


```{r aggregate_risk, include=F}
source("./R/util.R")
require_libraries(c("tidyr",
                    "dplyr",
                    "magrittr",
                    "ggplot2",
                    "knitr",
                    "kableExtra"
                    ))


dat_stack<-c()
for(i in 1:4){
  dat<-readRDS(paste0("./output/ReID_risk_persp",i,".rda")) %>%
    gather(risk_type,risk_score) %>%
    group_by(risk_type) %>%
    dplyr::summarize(risk_lower=quantile(risk_score,probs=0.05,na.rm=T),
                     risk_median=median(risk_score,na.rm=T),
                     risk_upper=quantile(risk_score,probs=0.95,na.rm=T)) %>%
    ungroup %>%
    mutate(perspective=paste0("Perspective_",i))
  
  dat_stack %<>% bind_rows(dat)
}

dat_stack<-c()
for(i in 1:4){
  dat<-readRDS(paste0("./output/ReID_risk_persp",i,".rda"))  %>% 
    gather(risk_type,risk_score) %>%
    group_by(risk_type) %>%
    dplyr::summarize(risk_lower=round(quantile(risk_score,probs=0.05,na.rm=T),4),
                     risk_median=round(median(risk_score,na.rm=T),4),
                     risk_upper=round(quantile(risk_score,probs=0.95,na.rm=T),4)) %>%
    ungroup %>%
    mutate(perspective=paste0("Perspective_",i))
  
  dat_stack %<>% bind_rows(dat)
}
```


```{r out, echo=F}
nice_tbl<-dat_stack %>%
  mutate(risk_low_perc=paste0(risk_lower*100,"%"),
         risk_med_perc=paste0(risk_median*100,"%"),
         risk_high_perc=paste0(risk_upper*100,"%")) %>%
  unite("risk_interv",c("risk_low_perc","risk_high_perc"),sep=",") %>%
  mutate(risk_label=paste0(risk_med_perc," (",risk_interv,")")) %>%
  dplyr::select(perspective, risk_type, risk_label) %>%
  dplyr::filter(risk_type %in% paste0("risk",2:6)) %>%
  mutate(risk_type=recode(risk_type,
                          risk2="Measure 1.1",
                          risk4="Measure 1.2",
                          risk3="Measure 2.1",
                          risk5="Measure 2.2",
                          risk6="Measure 3")) %>%
  spread(risk_type,risk_label)

kable(nice_tbl,
      caption="Table1 - Disclosure Risk Estimations") %>%
  kable_styling("striped", full_width = F)
```


#### Intepreting the Re-identification/Disclosure Risk ####
The 5 measures for re-identification risk, inspired by Statistical Disclosure Control([sdcMicro]), are calculated and reported for all of the data sets. The 5 disclodure risk measures will be described and explained in the following sections.

[sdcMicro]: https://cran.r-project.org/web/packages/sdcMicro/vignettes/sdc_guidelines.pdf

***


**Measure 1 - Population Uniquness**: It measures the estimated percentage of unique records within the underlying population (e.g. all hospitalization encounters over 10 years) from which the sample is drawn. The idea is that individual record having rare pattern (i.e. combination of variables) can be more easily identified and thus have a higher risk of re-identification/disclosure. Two models were used to estimate the risk assuming two typical distributions of frequency counts for the underlying population, which are negative binomial (Measure 1.1) [see Rinott and Shlomo, 2006] or poisson distributions (Measure 1.2) [see Skinner and Holmes, 1998]. When feature dimension is high, quality of Measure 1.2 tend to drop, which can be more accurate than Measure 1.1 with fewer features. 



**Measure 2 - Success Rate**: "Success rate" is defined as the likelihood of correct guess if each sample unique is matched to a randomly chosen individual from the same population cell. This measure is also estimated through two different models, negative binomial (Measure 2.1) [see Rinott and Shlomo, 2006] or poisson (Measure 2.2) [see Skinner and Holmes, 1998].   


For example, `r nice_tbl[1,4]` (Measure 3 for Perspective_1) can be interpreted as "for all the unique patterns observed in the sample, the overall chance for an intruder to identify a same pattern within the underlying population is `r nice_tbl[1,4]`".



**Measure 3 - % Records at risk**: This measure calculates the percentage of observations that are condiered risky and also have relatively higher risk than majority of the cohort. The default lower boundary of individual risk for a record being considered as "risky" is 0.1, while the lower boundary for a record being considered as "riskier than majority" is $2*(median(r)+2*MAD(r))$ where $r$ represents the vector of indivial risks. For example, `r nice_tbl[1,5]` (Measure 4 for Perspective_1) can be interpreted as "for all the sampling records, `r nice_tbl[1,5]` of them have more than 10% chance of being re-identified or being considered as extreme risky cases". `measure_risk()` function from the `sdcMicro` was directly adopted for calculating this measure.      


***


